<!DOCTYPE html>
<html lang="pl-PL">
<head>
    <meta charset="UTF-8">
    <title>{{ sesja.nazwa }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap + ikony -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
      html, body {
        height: 100%;
        margin: 0;
        background-color: #ffffff;
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      }
      .ekran-topbar {
        background-color: #0066cc;
        color: #ffffff;
        padding: 12px 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .ekran-topbar-title {
        font-size: 24px;
        font-weight: 600;
      }
      .ekran-topbar-sub {
        font-size: 16px;
        opacity: 0.85;
      }
      .ekran-topbar-right {
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .ekran-main {
        padding: 35px 60px 20px 60px;
        min-height: calc(100% - 80px);
        box-sizing: border-box;
      }
      .ekran-punkt-tytul {
        color: #222222;
        font-size: 40px;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .ekran-punkt-sub {
        font-size: 22px;
        color: #555555;
        margin-bottom: 25px;
      }
      .ekran-opis {
        font-size: 22px;
        margin-bottom: 35px;
      }
      .ekran-wyniki-header {
        font-size: 26px;
        font-weight: 600;
        margin-bottom: 15px;
      }
      .ekran-wyniki-row {
        font-size: 22px;
        margin-bottom: 10px;
      }
      .ekran-progbar {
        height: 32px;
        font-size: 18px;
      }
      .ekran-bottombar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #f1f3f5;
        border-top: 1px solid #dee2e6;
        padding: 6px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px;
      }
      .ekran-rollcall-wrap {
        margin-top: 18px;
        background: #ffffff;
        border: 1px solid #dfe3e7;
        border-radius: 10px;
        padding: 0;
        overflow: hidden;
      }
      .ekran-rollcall-head {
        background: #0b5ed7;
        color: #fff;
        padding: 10px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .ekran-rollcall-head .title {
        font-weight: 800;
        font-size: 20px;
        letter-spacing: .2px;
      }
      .ekran-rollcall-head .sub {
        font-size: 16px;
        opacity: .9;
      }
      .ekran-rollcall-banner {
        background: #e55353;
        color: #fff;
        font-weight: 900;
        letter-spacing: 1px;
        text-align: center;
        padding: 8px 16px;
        font-size: 18px;
      }
      .ekran-rollcall-grid {
        display: flex;
        flex-direction: column;
        width: 100%;
      }
      .ekran-rollcall-col {
        border-right: none;
      }
      .ekran-rollcall-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 1px 3px;
        border-bottom: 1px solid #edf0f2;
        font-size: 12px;
        min-height: 18px;
      }
      .ekran-rollcall-row:nth-child(even) {
        background: #f8f9fa;
      }
      .ekran-rollcall-lp {
        font-weight: 800;
        color: #495057;
        text-align: right;
        padding-right: 4px;
        min-width: 22px;
      }
      .ekran-rollcall-name {
        font-weight: 800;
        color: #212529;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
      }
      .ekran-rollcall-vote {
        display: flex;
        justify-content: flex-end;
        min-width: 50px;
      }
      .vote-badge {
        display: inline-block;
        min-width: 40px;
        text-align: center;
        padding: 1px 3px;
        border-radius: 999px;
        font-weight: 900;
        font-size: 11px;
      }
      .vb-za { background: rgba(25,135,84,.15); color: #198754; border: 1px solid rgba(25,135,84,.35); }
      .vb-przeciw { background: rgba(220,53,69,.12); color: #dc3545; border: 1px solid rgba(220,53,69,.30); }
      .vb-wstrzymuje { background: rgba(255,193,7,.18); color: #8a6d00; border: 1px solid rgba(255,193,7,.45); }
      .vb-brak { background: rgba(108,117,125,.10); color: #6c757d; border: 1px solid rgba(108,117,125,.25); }
      .ekran-wyniki-bar {
        margin-bottom: 18px;
      }
      .ekran-wyniki-label {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 6px;
      }
      .ekran-wyniki-progbar {
        height: 32px;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 8px;
      }
      .ekran-wyniki-liczba {
        font-size: 1.3rem;
        font-weight: 700;
        margin-left: 12px;
      }
      .ekran-wyniki-procent {
        font-size: 1.1rem;
        font-weight: 500;
        margin-left: 8px;
        color: #555;
      }
    </style>
</head>
<body>
<div class="ekran-topbar">
  <div>
    <div class="ekran-topbar-title">
      {{ sesja.nazwa }}
    </div>
    <div class="ekran-topbar-sub">
      {{ sesja.data }}
    </div>
  </div>
  <div class="ekran-topbar-right">
    <span id="ekran-czas"></span>
  </div>
</div>

<div class="ekran-main">
  {% if przerwa_trwa %}
    <div id="ekran-przerwa-banner" class="alert alert-warning text-center py-4 mb-4" style="font-size:2rem;">
      <i class="bi bi-pause-circle me-2"></i>
      Przerwa w obradach<br>
      Pozostały czas: <span id="ekran-przerwa-odliczanie">{{ przerwa_pozostalo }}</span>
    </div>
    <script>
      var pozostalo = {{ przerwa_pozostalo|default:0 }};
      var licznik = document.getElementById('ekran-przerwa-odliczanie');
      function formatujCzas(s) {
        var min = Math.floor(s/60);
        var sek = s%60;
        return min + ' min ' + sek + ' sek';
      }
      if (licznik && pozostalo > 0) {
        licznik.innerText = formatujCzas(pozostalo);
        var timer = setInterval(function() {
          pozostalo--;
          if (pozostalo <= 0) {
            licznik.innerText = 'Przerwa zakończona';
            clearInterval(timer);
          } else {
            licznik.innerText = formatujCzas(pozostalo);
          }
        }, 1000);
      }
    </script>
  {% endif %}
  <!-- Komunikat globalny (jeśli ustawiony) -->
  <!-- MODAL komunikatu globalnego -->
  <div class="modal fade" id="ekranKomunikatModal" tabindex="-1" aria-labelledby="ekranKomunikatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning-subtle">
          <h5 class="modal-title" id="ekranKomunikatModalLabel"><i class="bi bi-megaphone"></i> Komunikat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
        </div>
        <div class="modal-body text-center fs-4" id="ekran-komunikat-text"></div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
          <button type="button" class="btn btn-outline-danger d-none" id="ekran-komunikat-clear-btn"><i class="bi bi-x-circle"></i> Usuń komunikat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Plansza tytułowa sesji, gdy brak aktywnego punktu -->
  <div id="ekran-plansza-tytulowa" style="display:none;">
    <div class="text-center py-5">
      <h1 class="fw-bold" style="font-size:3rem;">{{ sesja.nazwa }}</h1>
      <div class="mb-3 fs-3 text-muted">{{ sesja.data|date:'d.m.Y H:i' }}</div>
      {% if sesja.opis %}
        <div class="mb-4 fs-4">{{ sesja.opis }}</div>
      {% endif %}
      <span class="badge bg-secondary fs-4 py-2 px-4">Sesja jeszcze nie rozpoczęła punktów obrad</span>
    </div>
  </div>

  <!-- Tytuł punktu i opis -->
  <h1 id="ekran-punkt-tytul" class="ekran-punkt-tytul">Brak aktywnego punktu</h1>
  <div id="ekran-punkt-sub" class="ekran-punkt-sub text-muted"></div>
  <div id="ekran-opis" class="ekran-opis"></div>

  <!-- Wyniki głosowania -->
  <div id="ekran-wyniki" style="display:none;"></div>

  <!-- Lista imienna (jawne) -->
  <div id="ekran-rollcall-wrap" class="ekran-rollcall-wrap" style="display:none;">
    <div class="ekran-rollcall-head">
      <div class="title">Lista imienna</div>
      <div class="sub">Nazwisko, imię • głos</div>
    </div>
    <div class="ekran-rollcall-banner" id="ekran-rollcall-banner">GŁOSOWANIE W TRAKCIE</div>
    <div class="ekran-rollcall-grid">
      <div class="ekran-rollcall-col" id="ekran-rollcall-col-1"></div>
      <div class="ekran-rollcall-col" id="ekran-rollcall-col-2"></div>
    </div>
  </div>
</div>

<div class="ekran-bottombar">
  <div>
    Aktywna sesja: <strong>{{ sesja.nazwa }}</strong>
  </div>
  <div>
    <span class="text-muted">System e-SIR</span>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Auto-refresh global message
    // Bootstrap modal instance
    var komunikatModal = new bootstrap.Modal(document.getElementById('ekranKomunikatModal'));
    var lastKomunikat = '';
    var isAdmin = {{ is_admin|yesno:'true,false' }};
    function odswiezKomunikatGlobalny() {
      $.getJSON('/api/ekran_komunikat/', function(data) {
        var komunikat = data.komunikat || '';
        var text = $('#ekran-komunikat-text');
        var clearBtn = $('#ekran-komunikat-clear-btn');
        if (komunikat) {
          text.text(komunikat);
          if (lastKomunikat !== komunikat) {
            komunikatModal.show();
            lastKomunikat = komunikat;
          }
          if (isAdmin) {
            clearBtn.removeClass('d-none');
          } else {
            clearBtn.addClass('d-none');
          }
        } else {
          komunikatModal.hide();
          lastKomunikat = '';
        }
      });
    }
    odswiezKomunikatGlobalny();
    setInterval(odswiezKomunikatGlobalny, 2000);

    // Admin clear button
    $('#ekran-komunikat-clear-btn').on('click', function() {
      $.post('/api/ekran_komunikat/clear/', function(resp) {
        if (resp.ok) {
          komunikatModal.hide();
          lastKomunikat = '';
        }
      });
    });
  // Zegar w prawym górnym rogu
  function aktualizujCzas() {
    const el = document.getElementById('ekran-czas');
    const now = new Date();
    const godzina = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
    const data = now.toLocaleDateString('pl-PL');
    el.textContent = data + ' ' + godzina;
  }
  aktualizujCzas();
  setInterval(aktualizujCzas, 1000);

  function escapeHtml(s) {
    return String(s || '').replace(/[&<>\"]/g, function(c) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c] || c);
    });
  }

  function normalize(s) {
    return String(s || '')
      .toLocaleLowerCase('pl-PL')
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '');
  }

  function voteMeta(glos) {
    if (glos === 'za') return {t: 'ZA', c: 'vb-za'};
    if (glos === 'przeciw') return {t: 'PRZECIW', c: 'vb-przeciw'};
    if (glos === 'wstrzymuje') return {t: 'WSTRZYM.', c: 'vb-wstrzymuje'};
    return {t: 'BRAK', c: 'vb-brak'};
  }

  function renderRollcall(list) {
    const items = [...(list || [])].sort((a, b) => {
      const an = normalize(a.nazwisko);
      const bn = normalize(b.nazwisko);
      if (an < bn) return -1;
      if (an > bn) return 1;
      const ai = normalize(a.imie);
      const bi = normalize(b.imie);
      if (ai < bi) return -1;
      if (ai > bi) return 1;
      return 0;
    });
    let html1 = '';
    let html2 = '';
    items.forEach((it, idx) => {
      const lp = idx + 1;
      const nazw = escapeHtml(it.nazwisko);
      const imie = escapeHtml(it.imie);
      const v = voteMeta(it.glos);
      const htmlRow = '<div class="ekran-rollcall-row">' +
        '<div class="ekran-rollcall-lp">' + lp + '.</div>' +
        '<div class="ekran-rollcall-name">' + nazw + ' ' + imie + '</div>' +
        '<div class="ekran-rollcall-vote"><span class="vote-badge ' + v.c + '">' + v.t + '</span></div>' +
      '</div>';
      if (idx < 11) {
        html1 += htmlRow;
      } else {
        html2 += htmlRow;
      }
    });
    const grid = $('.ekran-rollcall-grid');
    grid.empty();
    grid.append('<div class="ekran-rollcall-col">' + html1 + '</div>');
    grid.append('<div class="ekran-rollcall-col">' + html2 + '</div>');
  }

  // --- Anty-miganie: cache stanu + anulowanie poprzedniego requestu ---
  let lastRenderKey = null;
  let lastVotesKey = null;
  let aktywnyPunktXhr = null;

  function sameKey(a, b) { return a === b; }

  // Ładowanie aktywnego punktu i wyników
  function zaladujAktywnyPunkt() {
    // anuluj poprzedni request, jeśli jeszcze trwa
    if (aktywnyPunktXhr && aktywnyPunktXhr.readyState !== 4) {
      try { aktywnyPunktXhr.abort(); } catch (e) {}
    }

    aktywnyPunktXhr = $.get("{% url 'api_aktywny_punkt' sesja.id %}", function (data) {
      const tytulEl = $('#ekran-punkt-tytul');
      const subEl = $('#ekran-punkt-sub');
      const opisEl = $('#ekran-opis');
      const wynikiBox = $('#ekran-wyniki');
      const rollWrap = $('#ekran-rollcall-wrap');

      // klucz dla głównego widoku (punkt + głosowanie)
      const renderKey = JSON.stringify({
        aktywny: !!data.aktywny,
        numer: data.numer || null,
        tytul: data.tytul || null,
        podtytul: data.podtytul || null,
        opis: data.opis || null,
        glosowanie_id: data.glosowanie_id || null,
        glosowanie_nazwa: data.glosowanie_nazwa || null
      });

      if (!data.aktywny) {
        wynikiBox.hide(); // Wyniki zawsze ukryte, gdy punkt nieaktywny
        // Pokaż planszę tytułową sesji
        $('#ekran-plansza-tytulowa').show();
        $('#ekran-punkt-tytul').hide();
        subEl.hide();
        opisEl.hide();
        rollWrap.hide();
        $('#ekran-glosowanie-nazwa').text('');
        lastVotesKey = null;
        lastRenderKey = renderKey;
        return;
      } else {
        $('#ekran-plansza-tytulowa').hide();
        tytulEl.show();
        subEl.show();
        opisEl.show();
      }

      // aktualizuj nagłówki/opis tylko jeśli zmienił się punkt
      if (!sameKey(lastRenderKey, renderKey)) {
        // Automatyczne odświeżenie strony przy zmianie punktu
        if (lastRenderKey !== null) {
          location.reload();
          return;
        }
        tytulEl.text(data.numer + '. ' + (data.tytul || 'Punkt porządku obrad'));
        subEl.text(data.podtytul || '');
        opisEl.text(data.opis || '');
        lastRenderKey = renderKey;
      }

      if (data.glosowanie_id) {
        // nie chowaj/pokazuj na starcie każdego ticka; ustawimy po danych z API
        $.get("/api/wyniki/" + data.glosowanie_id + "/", function (wyn) {
          const tajne = !!wyn.tajne;
          const otwarte = !!wyn.otwarte;

          // klucz dla części "wyniki"
          const votesKey = JSON.stringify({
            gid: data.glosowanie_id,
            otwarte,
            tajne,
            za: wyn.za || 0,
            przeciw: wyn.przeciw || 0,
            wstrzymuje: wyn.wstrzymuje || 0
          });

          // Wyniki głosowania imiennego na kandydatów
          if (data.kandydaci && Array.isArray(data.kandydaci)) {
            let html = `
              <div class="ekran-wyniki-header mb-3">
                <h2 class="fw-bold text-center">Wyniki głosowania imiennego</h2>
                <hr>
              </div>
            `;
            if ((data.kandydaci_glosow_suma || 0) === 0) {
              html += '<div class="alert alert-info text-center">Brak oddanych głosów na kandydatów.</div>';
            } else {
              html += `<div class="mb-2 text-center text-muted">Oddano <span class="fw-bold">${data.kandydaci_glosow_suma}</span> głosów</div>`;
            }
            html += '<div class="table-responsive"><table class="table table-bordered table-striped table-hover align-middle mb-4"><thead><tr><th class="text-center">Nazwisko i imię</th><th class="text-center">Liczba głosów</th></tr></thead><tbody>';
            for (const k of data.kandydaci) {
              html += '<tr>';
              html += `<td class="fw-bold">${escapeHtml(k.nazwisko)} ${escapeHtml(k.imie)}</td>`;
              html += `<td class="text-center"><span class="badge bg-primary fs-5">${k.glosy}</span></td>`;
              html += '</tr>';
            }
            html += '</tbody></table></div>';
            $('#ekran-wyniki').html(html).show();
            wynikiBox.show();
            rollWrap.hide();
            lastVotesKey = votesKey;
            return;
          }

          // Wyniki jawne: lista imienna radnych i ich głosów tylko podczas otwartego głosowania
          if (!tajne && otwarte && data.glosowanie_id) {
            $.get('/api/glosy-jawne/' + data.glosowanie_id + '/', function (rollData) {
              const items = rollData.items || [];
              const maxPerCol = 14;
              const colCount = Math.ceil(items.length / maxPerCol);
              let html = `
                <div class="ekran-wyniki-header mb-3">
                  <h2 class="fw-bold text-center mb-2">Lista imienna głosowania</h2>
                  <hr style="margin-bottom:10px;">
                </div>
                <div class="row justify-content-center">`;
              for (let col = 0; col < colCount; col++) {
                html += '<div class="col-lg-6 col-md-12 mb-2"><ul class="list-group">';
                for (let i = col * maxPerCol; i < Math.min((col + 1) * maxPerCol, items.length); i++) {
                  const r = items[i];
                  const lp = i + 1;
                  let badgeClass = '';
                  let badgeText = '';
                  if (r.glos === 'za') { badgeClass = 'bg-success text-white fw-bold'; badgeText = 'ZA'; }
                  else if (r.glos === 'przeciw') { badgeClass = 'bg-danger text-white fw-bold'; badgeText = 'PRZECIW'; }
                  else if (r.glos === 'wstrzymuje') { badgeClass = 'bg-warning text-dark fw-bold'; badgeText = 'WSTRZYMUJE'; }
                  else if (r.glos === 'nieobecny' || r.glos === 'nieobecna') { badgeClass = 'bg-secondary text-white'; badgeText = 'NIEOBECNY'; }
                  else { badgeClass = 'bg-light text-muted'; badgeText = 'BRAK'; }
                  html += `<li class="list-group-item d-flex justify-content-between align-items-center" style="font-size:20px;padding:8px 16px;">`;
                  html += `<span><span class="text-muted">${lp}.</span> <span class="fw-bold">${escapeHtml(r.nazwisko)} ${escapeHtml(r.imie)}</span></span>`;
                  html += `<span class="badge ${badgeClass}" style="font-size:1.2rem;padding:8px 32px;border-radius:18px;min-width:120px;text-align:right;">${badgeText}</span>`;
                  html += '</li>';
                }
                html += '</ul></div>';
              }
              html += '</div>';
              $('#ekran-wyniki').html(html).show();
              wynikiBox.show();
              rollWrap.hide();
              lastVotesKey = votesKey;
            });
            return;
          }

          const za = wyn.za || 0;
          const przeciw = wyn.przeciw || 0;
          const wstrzymuje = wyn.wstrzymuje || 0;
          const suma = za + przeciw + wstrzymuje;

          // Po zamknięciu głosowania, jeśli oddano jakikolwiek głos, pokaż informację o wynikach
          if (!otwarte && suma > 0) {
            // Oblicz procenty
            const zaPct = suma ? Math.round(za / suma * 100) : 0;
            const przeciwPct = suma ? Math.round(przeciw / suma * 100) : 0;
            const wstrzymujePct = suma ? Math.round(wstrzymuje / suma * 100) : 0;
            let html = `<div class="ekran-wyniki-header mb-4">
              <h1 class="fw-bold text-center mb-2" style="font-size:2.2rem;">Wyniki głosowania</h1>
              <hr style="margin-bottom:18px;">
            </div>`;
            html += `<div class="mb-4">
              <div class="ekran-wyniki-label">Głosowanie: <span class="fw-normal">${escapeHtml(data.glosowanie_nazwa || '')}</span></div>
            </div>`;
            html += `<div class="ekran-wyniki-bar">
              <div class="ekran-wyniki-label text-success">ZA</div>
              <div class="progress ekran-wyniki-progbar mb-2">
                <div class="progress-bar bg-success" role="progressbar" style="width: ${zaPct}%\" aria-valuenow=\"${za}\" aria-valuemin=\"0\" aria-valuemax=\"${suma}\">${za}</div>
              </div>
              <span class="ekran-wyniki-liczba text-success">${za}</span>
              <span class="ekran-wyniki-procent">${zaPct}%</span>
            </div>`;
            html += `<div class="ekran-wyniki-bar">
              <div class="ekran-wyniki-label text-danger">PRZECIW</div>
              <div class="progress ekran-wyniki-progbar mb-2">
                <div class="progress-bar bg-danger" role="progressbar" style="width: ${przeciwPct}%\" aria-valuenow=\"${przeciw}\" aria-valuemin=\"0\" aria-valuemax=\"${suma}\">${przeciw}</div>
              </div>
              <span class="ekran-wyniki-liczba text-danger">${przeciw}</span>
              <span class="ekran-wyniki-procent">${przeciwPct}%</span>
            </div>`;
            html += `<div class="ekran-wyniki-bar">
              <div class="ekran-wyniki-label text-warning">WSTRZYMUJE SIĘ</div>
              <div class="progress ekran-wyniki-progbar mb-2">
                <div class="progress-bar bg-warning text-dark" role="progressbar" style="width: ${wstrzymujePct}%\" aria-valuenow=\"${wstrzymuje}\" aria-valuemin=\"0\" aria-valuemax=\"${suma}\">${wstrzymuje}</div>
              </div>
              <span class="ekran-wyniki-liczba text-warning">${wstrzymuje}</span>
              <span class="ekran-wyniki-procent">${wstrzymujePct}%</span>
            </div>`;
            $('#ekran-wyniki').html(html).show();
            wynikiBox.show();
            rollWrap.hide();
            lastVotesKey = votesKey;
            return;
          }
        }).fail(function () {
          // Jeśli coś nie działa z API, nie migaj - tylko schowaj jeśli to zmiana
          const votesKey = 'ERR:' + (data.glosowanie_id || '');
          if (!sameKey(lastVotesKey, votesKey)) {
            wynikiBox.hide();
            rollWrap.hide();
            $('#ekran-glosowanie-nazwa').text('');
            opisEl.text(data.opis || '');
            lastVotesKey = votesKey;
          }
        });
      } else {
        // brak głosowania
        const votesKey = 'NO_VOTE';
        if (!sameKey(lastVotesKey, votesKey)) {
          wynikiBox.hide();
          rollWrap.hide();
          $('#ekran-glosowanie-nazwa').text('');
          opisEl.text(data.opis || '');
          lastVotesKey = votesKey;
        }
      }
    });
  }

  zaladujAktywnyPunkt();
  setInterval(zaladujAktywnyPunkt, 2000);
</script>
</body>
</html>
