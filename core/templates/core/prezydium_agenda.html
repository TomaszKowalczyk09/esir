{% extends 'core/base.html' %}

{% block title %}Agenda sesji{% endblock %}

{% block content %}
<h3 class="mb-3">Agenda – aktywna sesja</h3>

{% if sesja %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body d-flex justify-content-between">
      <div>
        <h5 class="mb-1">{{ sesja.nazwa }}</h5>
        <p class="mb-0 text-muted">{{ sesja.data }}</p>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-success">Sesja aktywna</span>
        <a
          class="btn btn-sm btn-primary"
          href="{% url 'sesja_ekran_aktywna' %}"
          target="_blank"
          rel="noopener"
          title="Otwiera widok na rzutnik w nowej karcie"
        >
          Otwórz ekran sesji
        </a>
        <a
          class="btn btn-sm btn-warning"
          href="{% url 'ekran_komunikat' %}"
          title="Ustaw komunikat na ekranie sesji"
        >
          <i class="bi bi-chat-left-text me-1"></i> Ustaw komunikat na ekranie
        </a>
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary"
          id="copy-screen-link"
          data-url="{% url 'sesja_ekran_aktywna' %}"
          title="Kopiuje link do ekranu sesji do schowka"
        >
          Kopiuj link
        </button>
      </div>
    </div>
  </div>

  {% if punkty %}
    <div class="list-group shadow-sm">
      {% for punkt in punkty %}
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold">{{ punkt.numer }}. {{ punkt.tytul }}</div>
          {% if punkt.opis %}
            <div class="small text-muted">{{ punkt.opis }}</div>
          {% endif %}
          {% if punkt.glosowanie %}
            <div class="small text-muted mt-1">
              Głosowanie: {{ punkt.glosowanie.nazwa }}
              {% if punkt.glosowanie.otwarte %}
                <span class="badge bg-success ms-1">Otwarte</span>
              {% else %}
                <span class="badge bg-secondary ms-1">Zamknięte</span>
              {% endif %}
            </div>
          {% endif %}
        </div>
        <div class="text-end">
          {% if punkt.aktywny %}
            <span class="badge bg-primary mb-2 w-100">Aktualnie omawiany</span>
          {% endif %}

          <form method="post" action="{% url 'ustaw_punkt_aktywny' punkt.id %}" class="mb-1">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-primary w-100">
              Ustaw jako aktywny
            </button>
          </form>

          {% if punkt.glosowanie %}
          <button type="button"
                  class="btn btn-sm btn-outline-success w-100 toggle-glosowanie"
                  data-id="{{ punkt.glosowanie.id }}">
            {% if punkt.glosowanie.otwarte %}Zamknij głosowanie{% else %}Otwórz głosowanie{% endif %}
          </button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info mt-3">Brak punktów porządku obrad.</div>
  {% endif %}
{% else %}
  <div class="alert alert-warning">
    Brak aktywnej sesji. Ustaw sesję jako aktywną w widoku „Sesje”.
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(function () {
  $('.toggle-glosowanie').click(function () {
    const id = $(this).data('id');
    const btn = $(this);
    $.get('/glosowanie/' + id + '/toggle/', function (data) {
      if (data.otwarte) {
        btn.text('Zamknij głosowanie');
      } else {
        btn.text('Otwórz głosowanie');
      }
    });
  });

  $('#copy-screen-link').click(async function () {
    const path = $(this).data('url');
    const absoluteUrl = new URL(path, window.location.origin).toString();
    try {
      await navigator.clipboard.writeText(absoluteUrl);
      $(this).text('Skopiowano');
      setTimeout(() => $(this).text('Kopiuj link'), 1200);
    } catch (e) {
      // fallback: stary sposób
      const tmp = document.createElement('input');
      tmp.value = absoluteUrl;
      document.body.appendChild(tmp);
      tmp.select();
      document.execCommand('copy');
      document.body.removeChild(tmp);
      $(this).text('Skopiowano');
      setTimeout(() => $(this).text('Kopiuj link'), 1200);
    }
  });
});
</script>
{% endblock %}
