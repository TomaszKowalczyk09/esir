{% extends 'core/base.html' %}

<!-- Dostosuj Tomaszku :> -->
<style>
.loading-spinner {
  display: inline-block;
  width: 1rem;
  height: 1rem;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

{% block title %}Wyniki głosowań{% endblock %}

{% block content %}
<h3 class="mb-3">Wyniki głosowań – bieżąca sesja</h3>

{% if punkty %}
  {% for punkt in punkty %}
    <div class="card mb-3 shadow-sm">
      <div class="card-header">
        <strong>{{ punkt.numer }}. {{ punkt.tytul }}</strong>
        {% if punkt.glosowanie %}
          <span class="badge bg-secondary ms-2">
            {{ punkt.glosowanie.nazwa }}
          </span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if punkt.glosowanie %}
          <div id="wyniki-public-{{ punkt.glosowanie.id }}">
            <span class="loading-spinner"></span>
            <em>Ładowanie wyników...</em>
          </div>
        {% else %}
          <span class="text-muted">Brak głosowania dla tego punktu.</span>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">
    Brak aktywnej sesji lub brak punktów obrad.
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(function () {
  {% for punkt in punkty %} 
  // '(' expected.
    {% if punkt.glosowanie %}
    // Expression expected.
      (function(glosowanieId) {
        function odswiez() {
          $.get("{% url 'api_wyniki' punkt.glosowanie.id %}", function (data) {
            $('#wyniki-public-' + glosowanieId).html(
              '<strong>Wyniki:</strong> ' +
              'Za: <span class="text-success fw-bold">' + data.za + '</span> | ' +
              'Przeciw: <span class="text-danger fw-bold">' + data.przeciw + '</span> | ' +
              'Wstrzymuję się: <span class="text-warning fw-bold">' + data.wstrzymuje + '</span>'
            );
          });
        }
        odswiez();
        setInterval(odswiez, 2000);
      })({{ punkt.glosowanie.id }});
    {% endif %}
  {% endfor %}
});
</script>
{% endblock %}
