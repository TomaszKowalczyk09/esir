{% extends 'core/base.html' %}

{% block title %}Głosowania (Prezydium){% endblock %}

{% block content %}
<h3 class="mb-3">Głosowania – prezydium</h3>

<p class="text-muted">
  Poniżej widzisz wszystkie sesje, ich punkty oraz powiązane głosowania.
  Możesz otwierać i zamykać głosowania oraz przechodzić do ekranu sesji.
</p>

<div class="mb-3">
  <a href="{% url 'sesja_nowa' %}" class="btn btn-primary">
    <i class="bi bi-calendar-plus me-1"></i> Nowa sesja
  </a>
  <a href="{% url 'prezydium_sesje' %}" class="btn btn-outline-secondary ms-1">
    <i class="bi bi-list-ul me-1"></i> Lista sesji
  </a>
</div>

{% if sesje %}
  {% for sesja in sesje %}
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <strong>{{ sesja.nazwa }}</strong><br>
        <small class="text-muted">{{ sesja.data }}</small>
      </div>
      <div class="d-flex align-items-center">
        {% if sesja.aktywna %}
          <span class="badge bg-success me-2">Sesja aktywna</span>
        {% else %}
          <span class="badge bg-secondary me-2">Nieaktywna</span>
        {% endif %}

        <a href="{% url 'sesja_edytuj' sesja.id %}" class="btn btn-sm btn-outline-primary me-1">
          <i class="bi bi-pencil-square me-1"></i> Edytuj porządek
        </a>

        <a href="{% url 'sesja_ekran' sesja.id %}" target="_blank"
           class="btn btn-sm btn-outline-info me-1">
          <i class="bi bi-tv me-1"></i> Ekran sesji
        </a>
      </div>
    </div>

    <div class="card-body">
      {% if sesja.punkty.all %}
        {% for punkt in sesja.punkty.all %}
        <div class="border rounded p-3 mb-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1">
                {{ punkt.numer }}. {{ punkt.tytul }}
              </h6>
              {% if punkt.opis %}
                <p class="mb-1 text-muted">{{ punkt.opis }}</p>
              {% endif %}
            </div>
          </div>

          {% if punkt.glosowanie %}
          <div class="mt-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div>
                <strong>{{ punkt.glosowanie.nazwa }}</strong><br>
                <small id="wyniki-prez-{{ punkt.glosowanie.id }}" class="text-muted">
                  Wyniki: Za: 0 | Przeciw: 0 | Wstrzymuję: 0
                </small>
              </div>
              <button class="btn btn-sm btn-outline-success toggle-glosowanie"
                      data-id="{{ punkt.glosowanie.id }}">
                {% if punkt.glosowanie.otwarte %}Zamknij{% else %}Otwórz{% endif %}
              </button>
            </div>
          </div>
          {% else %}
            <small class="text-muted">Brak głosowania dla tego punktu.</small>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <span class="text-muted">Brak punktów obrad.</span>
      {% endif %}
    </div>
  </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">Brak utworzonych sesji.</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(function () {
  // Otwieranie / zamykanie głosowania
  $('.toggle-glosowanie').click(function () {
    const id = $(this).data('id');
    const btn = $(this);
    $.get('/glosowanie/' + id + '/toggle/', function (data) {
      if (data.otwarte) {
        btn.text('Zamknij');
      } else {
        btn.text('Otwórz');
      }
    });
  });

  // Wyniki live pod każdym głosowaniem
  {% for sesja in sesje %}
    {% for punkt in sesja.punkty.all %}
      {% if punkt.glosowanie %}
      (function(glosowanieId) {
        function odswiezWynikiPrez() {
          $.get('/api/wyniki/' + glosowanieId + '/', function (data) {
            const suma = data.za + data.przeciw + data.wstrzymuje;
            function procent(x) {
              return suma > 0 ? Math.round(x * 100 / suma) : 0;
            }
            $('#wyniki-prez-' + glosowanieId).text(
              'Wyniki: Za: ' + data.za + ' (' + procent(data.za) + '%)' +
              ' | Przeciw: ' + data.przeciw + ' (' + procent(data.przeciw) + '%)' +
              ' | Wstrzymuję: ' + data.wstrzymuje + ' (' + procent(data.wstrzymuje) + '%)'
            );
          });
        }
        odswiezWynikiPrez();
        setInterval(odswiezWynikiPrez, 2000);
      })({{ punkt.glosowanie.id }});
      {% endif %}
    {% endfor %}
  {% endfor %}
});
</script>
{% endblock %}
